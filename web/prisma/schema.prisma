datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/client"
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  password      String?
  role          String    @default("USER")
  accounts      Account[]
  sessions      Session[]
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  orders        Order[]
  deliveries    Delivery[] @relation("DriverDeliveries")
  routes        Route[]    @relation("DriverRoutes")
  employee      Employee?
  sendReceiptEmail Boolean @default(true)
}

model Account {
  id                 String  @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String?
  access_token       String?
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String?
  session_state      String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expires   DateTime

  @@unique([email, token])
}

model Meal {
  id            String      @id @default(cuid())
  title         String
  description   String?
  image         String
  price         Float
  calories      Int
  protein       Int
  carbs         Int
  fat           Int
  tags          String      // Comma separated tags
  category      String
  available     Boolean     @default(true)
  featured      Boolean     @default(false)  // Whether this meal appears on homepage
  featuredOrder Int?        // Order in which featured meals appear (1-5)
  productId     String?     @unique // 8-digit numerical ID starting with 7
  orderItems    OrderItem[]
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
}

model Order {
  id              String      @id @default(cuid())
  orderNumber     String      @unique // Unique order number like LMP-ABC123
  userId          String?
  user            User?       @relation(fields: [userId], references: [id])
  status          String      @default("PENDING") // PENDING, PAID, COMPLETED, CANCELLED, DELIVERED
  total           Float
  items           OrderItem[]
  
  // Guest / Shipping Info
  customerName    String
  customerEmail   String
  customerPhone   String?     // Optional phone number
  shippingAddress String
  city            String
  zipCode         String
  deliveryDate    DateTime?   // Optional delivery date selection

  squareOrderId   String?     // Square Order ID
  squarePaymentId String?     // Square Payment ID
  squareCheckoutId String?    // Square Checkout ID (from payment link)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  delivery        Delivery?
}

model OrderItem {
  id        String  @id @default(cuid())
  orderId   String
  order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  mealId    String
  meal      Meal    @relation(fields: [mealId], references: [id])
  quantity  Int
  price     Float   // Snapshot of price at time of order
}


model QuickBooksConfig {
  id              String   @id @default(cuid())
  realmId         String?  // QuickBooks Company ID
  accessToken     String?
  refreshToken    String?
  tokenExpiresAt  DateTime?
  refreshExpiresAt DateTime?
  lastSyncAt      DateTime?
  env             String   @default("sandbox") // sandbox or production
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Expense {
  id              String   @id @default(cuid())
  qbId            String   @unique
  description     String?
  amount          Float
  category        String?
  date            DateTime
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Delivery {
  id              String    @id @default(cuid())
  orderId         String    @unique
  order           Order     @relation(fields: [orderId], references: [id])
  driverId        String?
  driver          User?     @relation("DriverDeliveries", fields: [driverId], references: [id])
  status          String    @default("PENDING") // PENDING, IN_PROGRESS, DELIVERED, FAILED
  routeId         String?
  route           Route?    @relation(fields: [routeId], references: [id])
  sequence        Int?      // Order in the route
  
  // Proof of Delivery
  signedBy        String?
  signatureImage  String?
  deliveryPhoto   String?
  deliveredAt     DateTime?
  notes           String?
  
  // Geolocation (Captured at time of delivery)
  latitude        Float?
  longitude       Float?
  
  // Time Windows
  estimatedArrival DateTime?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model Route {
  id              String      @id @default(cuid())
  driverId        String?
  driver          User?       @relation("DriverRoutes", fields: [driverId], references: [id])
  deliveries      Delivery[]
  date            DateTime    @default(now())
  status          String      @default("PLANNED") // PLANNED, ACTIVE, COMPLETED
  optimized       Boolean     @default(false)
  
  // Performance metrics
  totalDistance   Float?      // In meters/km
  totalDuration   Int?        // In seconds/minutes
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
}

model Employee {
  id              String    @id @default(cuid())
  userId          String?   @unique
  user            User?     @relation(fields: [userId], references: [id])
  name            String
  email           String    @unique
  phone           String?
  position        String    // e.g., Head Chef, Driver, Office Manager
  department      String    // e.g., Kitchen, Logistics, Administration
  status          String    @default("ACTIVE") // ACTIVE, INACTIVE, ON_LEAVE
  salary          Float?    // Annual salary
  hireDate        DateTime  @default(now()) // Date of hire
  startDate       DateTime  @default(now())
  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model PromoCode {
  id                String    @id @default(cuid())
  code              String    @unique // Any characters allowed (3-20 characters)
  discountType      String    // PERCENTAGE or FIXED
  discountValue     Float     // Percentage (0-100) or fixed dollar amount
  
  // Date Range
  startDate         DateTime
  endDate           DateTime
  
  // Usage Limits
  maxRedemptions    Int?      // Optional maximum total uses
  currentRedemptions Int      @default(0) // Track current usage
  
  // Applicability
  applicableProducts String?  // Comma-separated meal IDs (null = all products)
  applicableCategories String? // Comma-separated categories (null = all categories)
  
  // Minimum Order Requirements
  minOrderValue     Float?    // Optional minimum order value
  
  // Status
  isActive          Boolean   @default(true)
  
  // Metadata
  description       String?   // Internal description
  createdBy         String?   // Admin user ID who created it
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@index([code])
  @@index([isActive])
  @@index([startDate, endDate])
}

model AuditLog {
  id              String    @id @default(cuid())
  action          String    // e.g., CREATE_EMPLOYEE, UPDATE_EMPLOYEE, DELETE_EMPLOYEE, CREATE_PROMO, UPDATE_PROMO, DELETE_PROMO
  entityType      String    // e.g., EMPLOYEE, PROMO_CODE
  entityId        String?
  userId          String?   // The admin who performed the action
  userName        String?
  details         String?   // JSON string of changes
  createdAt       DateTime  @default(now())
}



